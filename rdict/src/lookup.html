<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>RDict</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Microsoft YaHei', sans-serif;
      overflow: hidden;
      background: #2a2a2a;
      color: #e0e0e0;
      height: 100%;
      border-radius: 10px;
    }

    /* ========== ÊêúÁ¥¢Ê°Ü ========== */
    .search-layer {
      padding: 12px 14px;
      background: #2a2a2a;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: grab;
      border-radius: 10px 10px 0 0;
    }

    .search-layer:active {
      cursor: grabbing;
    }

    .search-icon {
      color: #666;
      font-size: 16px;
      flex-shrink: 0;
    }

    #searchInput {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: #e0e0e0;
      font-size: 16px;
      padding: 4px 0;
    }

    #searchInput::placeholder {
      color: #666;
    }

    .clear-btn {
      background: #555;
      border: none;
      color: #fff;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      line-height: 18px;
      text-align: center;
      display: none;
      flex-shrink: 0;
    }

    .clear-btn.show {
      display: block;
    }

    .clear-btn:hover {
      background: #666;
    }

    /* ========== ÂÜÖÂÆπÂå∫Âüü ========== */
    .content-area {
      display: none;
      overflow-y: auto;
      overflow-x: hidden;
      background: #1a1a1a;
      flex: 1;
    }

    .content-area.show {
      display: block;
    }

    /* ========== ÂçïËØçÂàóË°® ========== */
    .word-list-container {
      display: none;
    }

    .word-list-container.show {
      display: block;
    }

    .word-item {
      padding: 10px 16px;
      cursor: pointer;
      border-bottom: 1px solid #2a2a2a;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      transition: background 0.1s;
    }

    .word-item:hover {
      background: #2d2d2d;
    }

    .word-item.active {
      background: #333;
    }

    .word-info {
      flex: 1;
      min-width: 0;
    }

    .word-title-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .word-title {
      font-size: 15px;
      font-weight: 500;
      color: #fff;
    }

    .word-source {
      font-size: 10px;
      color: #888;
      background: #333;
      padding: 1px 5px;
      border-radius: 3px;
    }

    .word-source.online {
      background: #1a3a2a;
      color: #5a9;
    }

    .word-brief {
      font-size: 13px;
      color: #888;
      line-height: 1.4;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .word-shortcut {
      color: #555;
      font-size: 12px;
      margin-left: 12px;
      flex-shrink: 0;
    }

    /* ========== ËØ¶ÁªÜËß£Èáä ========== */
    .definition-container {
      display: none;
      padding: 16px;
    }

    .definition-container.show {
      display: block;
    }

    .definition-container img {
      max-width: 100%;
      height: auto;
    }

    .definition-container table {
      border-collapse: collapse;
      max-width: 100%;
    }

    .error {
      padding: 16px;
      background: #3a2525;
      color: #e88;
      border-radius: 6px;
    }

    .not-found {
      padding: 16px;
      background: #3a3525;
      color: #da6;
      border-radius: 6px;
      text-align: center;
    }

    /* ========== Â∫ïÈÉ®ËèúÂçï ========== */
    .bottom-menu {
      display: none;
      background: #222;
      border-top: 1px solid #3a3a3a;
      padding: 6px 0;
      flex-shrink: 0;
    }

    .bottom-menu.show {
      display: block;
    }

    .menu-item {
      padding: 10px 16px;
      color: #e0e0e0;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.1s;
    }

    .menu-item:hover {
      background: #2d2d2d;
    }

    /* ========== Èü≥È¢ëÊí≠ÊîæÂô® ========== */
    #audioPlayer {
      position: fixed;
      bottom: 10px;
      left: 10px;
      right: 10px;
      height: 40px;
      background: #2a2a2a;
      border: 1px solid #3a3a3a;
      border-radius: 6px;
      display: none;
      align-items: center;
      padding: 0 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    #audioPlayer.show {
      display: flex;
    }

    #audioPlayer audio {
      height: 30px;
      flex: 1;
    }

    #audioPlayer .close {
      margin-left: 10px;
      padding: 4px 10px;
      background: #c44;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }

    #audioPlayer .close:hover {
      background: #a33;
    }

    /* ========== ÊªöÂä®Êù° ========== */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: #444;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }

    /* ========== Âä†ËΩΩÁä∂ÊÄÅ ========== */
    .loading-indicator {
      text-align: center;
      padding: 20px;
      color: #666;
      font-size: 13px;
    }

    .loading-indicator::before {
      content: '';
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #444;
      border-top-color: #888;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ========== ‰∏ªÂÆπÂô® ========== */
    .main-container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <!-- ÊêúÁ¥¢Ê°ÜÔºàÂßãÁªàÊòæÁ§∫Ôºâ -->
    <div class="search-layer" data-tauri-drag-region>
      <span class="search-icon">üîç</span>
      <input type="text" id="searchInput" placeholder="ÊêúÁ¥¢" autofocus>
      <button class="clear-btn" id="clearBtn">√ó</button>
    </div>

    <!-- ÂÜÖÂÆπÂå∫Âüü -->
    <div class="content-area" id="contentArea">
      <!-- ÂçïËØçÂàóË°® -->
      <div class="word-list-container" id="wordListContainer"></div>
      
      <!-- ËØ¶ÁªÜËß£Èáä -->
      <div class="definition-container" id="definitionContainer"></div>
    </div>

    <!-- Â∫ïÈÉ®ËèúÂçï -->
    <div class="bottom-menu" id="bottomMenu">
      <div class="menu-item" onclick="openSettings()">ÂÅèÂ•ΩËÆæÁΩÆ...</div>
      <div class="menu-item" onclick="closeApp()">ÈÄÄÂá∫ RDict</div>
    </div>
  </div>

  <!-- Èü≥È¢ëÊí≠ÊîæÂô® -->
  <div id="audioPlayer">
    <audio id="audio" controls></audio>
    <button class="close" onclick="closeAudioPlayer()">√ó</button>
  </div>

  <script type="module">
    import { invoke } from '@tauri-apps/api/core';
    import { listen } from '@tauri-apps/api/event';
    import { getCurrentWindow } from '@tauri-apps/api/window';

    const appWindow = getCurrentWindow();

    const searchInput = document.getElementById('searchInput');
    const clearBtn = document.getElementById('clearBtn');
    const contentArea = document.getElementById('contentArea');
    const wordListContainer = document.getElementById('wordListContainer');
    const definitionContainer = document.getElementById('definitionContainer');
    const bottomMenu = document.getElementById('bottomMenu');

    let searchTimeout = null;
    let currentWords = [];
    let selectedIndex = -1;
    let currentView = 'initial';

    // ========== ÁïåÈù¢ÂàáÊç¢ ==========
    function switchView(view) {
      currentView = view;
      
      // ÈöêËóèÊâÄÊúâÂÜÖÂÆπ
      contentArea.classList.remove('show');
      wordListContainer.classList.remove('show');
      definitionContainer.classList.remove('show');
      bottomMenu.classList.remove('show');
      
      // Ê†πÊçÆÁïåÈù¢ÊòæÁ§∫ÂØπÂ∫îÂÜÖÂÆπ
      if (view === 'initial') {
        bottomMenu.classList.add('show');
        resizeWindow(600, 52);
      } else if (view === 'list') {
        contentArea.classList.add('show');
        wordListContainer.classList.add('show');
        bottomMenu.classList.add('show');
        resizeWindow(600, 400);
      } else if (view === 'definition') {
        contentArea.classList.add('show');
        definitionContainer.classList.add('show');
        resizeWindow(600, 600);
      }
    }

    async function resizeWindow(width, height) {
      try {
        await appWindow.setSize({ type: 'Logical', width, height });
      } catch (e) {
        console.error('Failed to resize window:', e);
      }
    }

    // ========== ÊêúÁ¥¢ËæìÂÖ•Â§ÑÁêÜ ==========
    searchInput.addEventListener('input', (e) => {
      const query = e.target.value.trim();
      clearBtn.classList.toggle('show', query.length > 0);
      
      clearTimeout(searchTimeout);
      if (query) {
        searchTimeout = setTimeout(() => {
          searchWords(query);
        }, 150);
      } else {
        clearWordList();
        switchView('initial');
      }
    });

    clearBtn.addEventListener('click', () => {
      searchInput.value = '';
      clearBtn.classList.remove('show');
      clearWordList();
      switchView('initial');
      searchInput.focus();
    });

    // ========== ÈîÆÁõòÂØºËà™ ==========
    searchInput.addEventListener('keydown', (e) => {
      if (currentView === 'list') {
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectWord(selectedIndex + 1);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectWord(selectedIndex - 1);
        } else if (e.key === 'Enter') {
          e.preventDefault();
          if (selectedIndex >= 0 && currentWords[selectedIndex]) {
            lookupWordDetail(currentWords[selectedIndex]);
          } else if (searchInput.value.trim()) {
            lookupWordDetail({ word: searchInput.value.trim(), source: 'local' });
          }
        } else if (e.key === 'Escape') {
          searchInput.value = '';
          clearBtn.classList.remove('show');
          clearWordList();
          switchView('initial');
        }
      } else if (currentView === 'definition') {
        if (e.key === 'Escape') {
          if (currentWords.length > 0) {
            switchView('list');
          } else {
            searchInput.value = '';
            clearBtn.classList.remove('show');
            switchView('initial');
          }
        } else if (e.key === 'Enter' && searchInput.value.trim()) {
          searchWords(searchInput.value.trim());
        }
      } else if (currentView === 'initial') {
        if (e.key === 'Enter' && searchInput.value.trim()) {
          searchWords(searchInput.value.trim());
        } else if (e.key === 'Escape') {
          closeApp();
        }
      }
    });

    // ========== ÊêúÁ¥¢ÂçïËØç ==========
    async function searchWords(query) {
      wordListContainer.innerHTML = '<div class="loading-indicator">ÊêúÁ¥¢‰∏≠...</div>';
      switchView('list');
      
      try {
        const results = await invoke('search_words', { query });
        currentWords = results;
        selectedIndex = -1;
        renderWordList();
      } catch (error) {
        wordListContainer.innerHTML = '<div class="loading-indicator" style="color: #e88;">ÊêúÁ¥¢Â§±Ë¥•</div>';
      }
    }

    function renderWordList() {
      if (currentWords.length === 0) {
        wordListContainer.innerHTML = '<div class="loading-indicator" style="color: #888;">Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÂçïËØç</div>';
        return;
      }

      wordListContainer.innerHTML = currentWords.map((item, index) => `
        <div class="word-item ${index === selectedIndex ? 'active' : ''}" 
             data-index="${index}"
             onclick="window.selectAndLookup(${index})">
          <div class="word-info">
            <div class="word-title-row">
              <span class="word-title">${escapeHtml(item.word)}</span>
              ${item.source === 'online' ? '<span class="word-source online">ÁΩëÁªú</span>' : ''}
            </div>
            <div class="word-brief">${escapeHtml(item.brief || '')}</div>
          </div>
          ${index < 9 ? `<span class="word-shortcut">‚åò${index + 1}</span>` : ''}
        </div>
      `).join('');
    }

    function selectWord(index) {
      if (currentWords.length === 0) return;
      
      if (index < 0) index = currentWords.length - 1;
      if (index >= currentWords.length) index = 0;
      
      selectedIndex = index;
      renderWordList();
      
      const activeItem = wordListContainer.querySelector('.word-item.active');
      if (activeItem) {
        activeItem.scrollIntoView({ block: 'nearest' });
      }
    }

    function selectAndLookup(index) {
      selectedIndex = index;
      if (currentWords[index]) {
        lookupWordDetail(currentWords[index]);
      }
    }

    async function lookupWordDetail(item) {
      definitionContainer.innerHTML = '<div class="loading-indicator">Âä†ËΩΩ‰∏≠...</div>';
      switchView('definition');
      
      try {
        let result;
        if (item.source === 'online') {
          const response = await invoke('lookup_word_online', { word: item.word });
          result = response.result;
        } else {
          const response = await invoke('lookup_word', { word: item.word });
          result = response.result;
        }
        definitionContainer.innerHTML = result;
      } catch (error) {
        definitionContainer.innerHTML = '<div class="error">Âä†ËΩΩÂ§±Ë¥•</div>';
      }
    }

    function clearWordList() {
      currentWords = [];
      selectedIndex = -1;
      wordListContainer.innerHTML = '';
    }

    // ========== Âø´Êç∑ÈîÆÊîØÊåÅ (‚åò1-9) ==========
    document.addEventListener('keydown', (e) => {
      if ((e.metaKey || e.ctrlKey) && e.key >= '1' && e.key <= '9') {
        const index = parseInt(e.key) - 1;
        if (currentWords[index]) {
          e.preventDefault();
          selectAndLookup(index);
        }
      }
    });

    // ========== Â∑•ÂÖ∑ÂáΩÊï∞ ==========
    function escapeHtml(text) {
      if (!text) return '';
      const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
      return text.replace(/[&<>"']/g, m => map[m]);
    }

    async function openSettings() {
      await appWindow.hide();
    }

    async function closeApp() {
      await appWindow.close();
    }

    // ========== Èü≥È¢ëÊí≠Êîæ ==========
    document.addEventListener('click', function(e) {
      const link = e.target.closest('a');
      if (!link) return;

      const href = link.getAttribute('href');
      if (href && (href.endsWith('.mp3') || href.endsWith('.wav') || href.endsWith('.ogg'))) {
        e.preventDefault();
        playAudio(href);
        return false;
      }

      if (href && href.startsWith('mdd-resource://')) {
        e.preventDefault();
        const resourceName = href.replace('mdd-resource://', '');
        if (resourceName.endsWith('.mp3') || resourceName.endsWith('.wav') || resourceName.endsWith('.ogg')) {
          playResourceAudio(resourceName);
        }
        return false;
      }
    }, true);

    function playAudio(src) {
      const audioPlayer = document.getElementById('audioPlayer');
      const audio = document.getElementById('audio');

      audio.src = src;
      audio.play().catch(err => {
        console.error('Failed to play audio:', err);
      });

      audioPlayer.classList.add('show');

      audio.onended = function() {
        setTimeout(() => {
          audioPlayer.classList.remove('show');
        }, 500);
      };
    }

    async function playResourceAudio(resourceName) {
      try {
        const data = await invoke('get_mdd_resource', { resourceName });
        if (data) {
          const blob = new Blob([new Uint8Array(data)]);
          const url = URL.createObjectURL(blob);
          playAudio(url);
        }
      } catch (error) {
        console.error('Failed to load audio resource:', error);
      }
    }

    function closeAudioPlayer() {
      const audioPlayer = document.getElementById('audioPlayer');
      const audio = document.getElementById('audio');

      audio.pause();
      audio.src = '';
      audioPlayer.classList.remove('show');
    }

    // ========== ÁõëÂê¨Â§ñÈÉ®Êü•ËØ¢ËØ∑Ê±Ç ==========
    listen('clipboard-word', (event) => {
      const word = event.payload;
      searchInput.value = word;
      clearBtn.classList.add('show');
      searchWords(word);
    });

    // ========== ÂàùÂßãÂåñ ==========
    window.addEventListener('load', () => {
      searchInput.focus();
      switchView('initial');
    });

    // Start drag on search layer
    document.querySelector('[data-tauri-drag-region]').addEventListener('mousedown', async (e) => {
      if (e.target === searchInput || e.target === clearBtn) return;
      await appWindow.startDragging();
    });

    // Expose functions to window for onclick handlers
    window.selectAndLookup = selectAndLookup;
    window.openSettings = openSettings;
    window.closeApp = closeApp;
    window.closeAudioPlayer = closeAudioPlayer;
  </script>
</body>
</html>
