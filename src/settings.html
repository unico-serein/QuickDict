<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>QuickDict Settings</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 2px 20px rgba(0,0,0,0.1);
    }

    h1 {
      color: #333;
      margin-bottom: 25px;
      font-size: 24px;
    }

    .section {
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid #eee;
    }

    .section:last-child {
      border-bottom: none;
    }

    .section h3 {
      color: #667eea;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 15px;
    }

    .setting-item {
      margin: 15px 0;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .setting-item label {
      color: #555;
      font-size: 14px;
    }

    input[type="text"],
    select {
      width: 200px;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 13px;
      font-family: inherit;
      outline: none;
      transition: border-color 0.3s;
    }

    input[type="text"]:focus,
    select:focus {
      border-color: #667eea;
    }

    input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .shortcut-display {
      display: inline-block;
      background: #667eea;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-family: monospace;
      font-size: 13px;
    }

    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      margin-right: 8px;
      transition: background 0.3s;
    }

    button:hover {
      background: #5568d3;
    }

    button.secondary {
      background: #999;
    }

    button.secondary:hover {
      background: #777;
    }

    .info-text {
      font-size: 12px;
      color: #888;
      margin-top: 5px;
    }

    .checkbox-wrapper {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .close-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: none;
      border: none;
      font-size: 24px;
      color: #999;
      cursor: pointer;
      padding: 5px;
    }

    .close-btn:hover {
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>⚙ Settings</h1>

    <div class="section">
      <h3>Hotkey Settings</h3>
      <div class="setting-item">
        <label>Global Hotkey:</label>
        <span id="currentHotkey" class="shortcut-display">Alt+M</span>
      </div>
      <div class="setting-item">
        <div></div>
        <div>
          <input type="text" id="hotkeyInput" placeholder="Press keys..." />
          <div class="info-text">Click and press key combination</div>
        </div>
      </div>
      <div class="setting-item">
        <div></div>
        <div>
          <button onclick="applyHotkey()">Apply</button>
          <button class="secondary" onclick="resetHotkey()">Reset</button>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>Display Settings</h3>
      <div class="setting-item">
        <label>Font Family:</label>
        <select id="fontFamily" onchange="changeFontFamily()">
          <option value="">Loading fonts...</option>
        </select>
      </div>
      <div class="setting-item">
        <label>Font Size:</label>
        <select id="fontSize" onchange="changeFontSize()">
          <option value="12">12px (极小)</option>
          <option value="14" selected>14px (小)</option>
          <option value="16">16px (中)</option>
          <option value="18">18px (大)</option>
          <option value="20">20px (极大)</option>
        </select>
      </div>
      <div class="setting-item">
        <label>Line Height:</label>
        <select id="lineHeight" onchange="changeLineHeight()">
          <option value="1.4">1.4 (紧凑)</option>
          <option value="1.6" selected>1.6 (标准)</option>
          <option value="1.8">1.8 (宽松)</option>
          <option value="2.0">2.0 (很宽)</option>
        </select>
      </div>
    </div>

    <div class="section">
      <h3>Clipboard Monitor</h3>
      <div class="setting-item">
        <label>Auto lookup on copy:</label>
        <div class="checkbox-wrapper">
          <input type="checkbox" id="clipboardMonitor" checked onchange="toggleClipboardMonitor()">
          <span class="info-text">Automatically lookup when copying</span>
        </div>
      </div>
    </div>

    <div class="section">
      <h3>About</h3>
      <div class="setting-item">
        <label>Dictionary:</label>
        <span class="info-text">牛津高阶英汉双解词典(第9版)</span>
      </div>
      <div class="setting-item">
        <label>Status:</label>
        <span class="info-text" style="color: #4CAF50;">Ready</span>
      </div>
    </div>

    <div class="section">
      <div style="text-align: center; margin-top: 20px;">
        <button class="secondary" onclick="closeSettings()">Close Settings</button>
      </div>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    let currentHotkey = 'Alt+M';
    let recordingHotkey = false;

    const hotkeyInput = document.getElementById('hotkeyInput');

    hotkeyInput.addEventListener('focus', function() {
      recordingHotkey = true;
      hotkeyInput.value = '';
      hotkeyInput.placeholder = 'Press keys...';
    });

    hotkeyInput.addEventListener('blur', function() {
      recordingHotkey = false;
    });

    hotkeyInput.addEventListener('keydown', function(e) {
      if (!recordingHotkey) return;
      e.preventDefault();
      e.stopPropagation();

      const parts = [];
      if (e.ctrlKey) parts.push('Ctrl');
      if (e.altKey) parts.push('Alt');
      if (e.shiftKey) parts.push('Shift');
      if (e.metaKey) parts.push('Cmd');

      if (!e.ctrlKey && !e.altKey && !e.shiftKey && !e.metaKey) {
        parts.push(e.key.toUpperCase());
      }

      if (parts.length > 0) {
        hotkeyInput.value = parts.join('+');
      }
    });

    function applyHotkey() {
      const newHotkey = hotkeyInput.value.trim();
      if (!newHotkey) {
        alert('Please enter a hotkey combination');
        return;
      }

      ipcRenderer.send('set-hotkey', newHotkey);
      currentHotkey = newHotkey;
      document.getElementById('currentHotkey').textContent = currentHotkey;
      hotkeyInput.value = '';
    }

    function resetHotkey() {
      ipcRenderer.send('set-hotkey', 'Alt+M');
      currentHotkey = 'Alt+M';
      document.getElementById('currentHotkey').textContent = currentHotkey;
      hotkeyInput.value = '';
    }

    function toggleClipboardMonitor() {
      const enabled = document.getElementById('clipboardMonitor').checked;
      ipcRenderer.send('toggle-clipboard-monitor', enabled);
    }

    function changeFontFamily() {
      const fontFamily = document.getElementById('fontFamily').value;
      ipcRenderer.send('set-font-family', fontFamily);
    }

    function changeFontSize() {
      const fontSize = document.getElementById('fontSize').value;
      ipcRenderer.send('set-font-size', fontSize);
    }

    function changeLineHeight() {
      const lineHeight = document.getElementById('lineHeight').value;
      ipcRenderer.send('set-line-height', lineHeight);
    }

    // 获取系统字体列表（使用浏览器API）
    async function getSystemFonts() {
      // 使用 FontFace API 获取系统字体
      const fonts = new Set();

      // 常见字体列表（用于检测）
      const commonFonts = [
        'Arial', 'Arial Black', 'Arial Narrow', 'Arial Unicode MS',
        'Calibri', 'Cambria', 'Cambria Math', 'Consolas', 'Courier', 'Courier New',
        'Georgia', 'Helvetica', 'Impact', 'Lucida Console', 'Microsoft Sans Serif',
        'Palatino Linotype', 'Segoe UI', 'Segoe UI Light', 'Segoe UI Semibold',
        'Tahoma', 'Times', 'Times New Roman', 'Trebuchet MS', 'Verdana',
        'Microsoft YaHei', 'SimSun', 'SimHei', 'KaiTi', 'FangSong', 'LiSu',
        'YouYuan', 'STXihei', 'STKaiti', 'STSong', 'STZhongsong', 'STFangsong',
        'FSong', 'FKai', 'FZShuTi', 'FZYaoti', 'FZCuSong', 'FZCuKai',
        'MingLiU', 'PMingLiU', 'DMingLiU', 'DFKai-SB',
        'Gulim', 'Dotum', 'Batang', 'Gungsuh',
        'Meiryo', 'MS Gothic', 'MS PGothic', 'MS Mincho', 'MS PMincho',
        'Osaka', 'Hiragino Kaku Gothic Pro', 'Hiragino Mincho Pro Pro',
        'Songti SC', 'Songti TC', 'STHeiti', 'STKaiti',
        'Plantagenet Cherokee', 'Tunga', 'Sylfaen', 'Estrangelo Edessa',
        'Raghindi', 'Kartika', 'Gautami', 'Latha', 'Mangal', 'Vrinda',
        'Shruti', 'Tunga', 'Raavi', 'Nirmala UI', 'Ebrima',
        'Aparajita', 'Kokila', 'Utsaah', 'Vani'
      ];

      // 检测字体是否可用
      function fontAvailable(fontFamily) {
        // 创建测试元素
        const testText = 'mmmmmmmmmmlli';
        const testFont = 'monospace';

        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');

        // 设置默认字体
        context.font = `72px ${testFont}`;
        const defaultWidth = context.measureText(testText).width;

        // 设置测试字体
        context.font = `72px "${fontFamily}", ${testFont}`;
        const testWidth = context.measureText(testText).width;

        return defaultWidth !== testWidth;
      }

      // 检测所有常见字体
      commonFonts.forEach(font => {
        if (fontAvailable(font)) {
          fonts.add(font);
        }
      });

      // 获取 document.fonts 中的字体
      if (document.fonts) {
        for (const fontFace of document.fonts) {
          if (fontFace.family) {
            fonts.add(fontFace.family);
          }
        }
      }

      return Array.from(fonts).sort();
    }

    // 加载系统字体列表
    async function loadSystemFonts() {
      const select = document.getElementById('fontFamily');

      try {
        console.log('Loading system fonts...');
        const systemFonts = await getSystemFonts();
        console.log(`Found ${systemFonts.length} fonts`);

        if (systemFonts.length > 0) {
          // 清空现有选项
          select.innerHTML = '';

          // 添加字体选项（优先显示常用字体）
          const commonFonts = [
            'Segoe UI',
            'Microsoft YaHei',
            'SimSun',
            'KaiTi',
            'FangSong',
            'Arial',
            'Times New Roman',
            'Georgia',
            'Verdana',
            'Consolas'
          ];

          // 创建副本避免修改原数组
          const remainingFonts = [...systemFonts];

          // 先添加常用字体
          commonFonts.forEach(font => {
            if (remainingFonts.includes(font)) {
              const option = document.createElement('option');
              option.value = font;
              option.textContent = font;
              option.style.fontFamily = font;
              select.appendChild(option);
              // 从副本列表中移除已添加的字体
              const index = remainingFonts.indexOf(font);
              if (index > -1) {
                remainingFonts.splice(index, 1);
              }
            }
          });

          // 添加分隔线和其他字体数量
          const separator = document.createElement('option');
          separator.disabled = true;
          separator.textContent = `────────── (其他 ${remainingFonts.length} 个字体)`;
          select.appendChild(separator);

          // 添加其他系统字体
          remainingFonts.forEach(font => {
            const option = document.createElement('option');
            option.value = font;
            option.textContent = font;
            option.style.fontFamily = font;
            select.appendChild(option);
          });

          console.log(`Added ${select.options.length} font options`);
        } else {
          throw new Error('No fonts found');
        }
      } catch (error) {
        console.error('Failed to load fonts:', error);
        // 如果获取失败，使用默认列表
        select.innerHTML = `
          <option value="Segoe UI">Segoe UI (默认)</option>
          <option value="Microsoft YaHei">微软雅黑</option>
          <option value="SimSun">宋体</option>
          <option value="KaiTi">楷体</option>
          <option value="FangSong">仿宋</option>
          <option value="Arial">Arial</option>
          <option value="Times New Roman">Times New Roman</option>
          <option value="Georgia">Georgia</option>
          <option value="Verdana">Verdana</option>
          <option value="Consolas">Consolas</option>
        `;
        console.log('Using default fonts list');
      }
    }

    // 加载保存的设置
    function loadSettings() {
      loadSystemFonts();

      const settings = ipcRenderer.sendSync('get-display-settings');
      if (settings) {
        // 等待字体列表加载完成后再设置值
        setTimeout(() => {
          const fontSelect = document.getElementById('fontFamily');
          if (fontSelect) {
            fontSelect.value = settings.fontFamily || 'Segoe UI';
          }
        }, 100);

        document.getElementById('fontSize').value = settings.fontSize || '14';
        document.getElementById('lineHeight').value = settings.lineHeight || '1.6';
        document.getElementById('clipboardMonitor').checked = settings.clipboardMonitor !== false;
      }
    }

    // 页面加载时加载设置
    window.addEventListener('load', loadSettings);

    function closeSettings() {
      window.close();
    }

    ipcRenderer.on('hotkey-updated', (event, hotkey) => {
      currentHotkey = hotkey;
      document.getElementById('currentHotkey').textContent = currentHotkey;
    });
  </script>
</body>
</html>
